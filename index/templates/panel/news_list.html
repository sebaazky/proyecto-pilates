{# index/templates/panel/news_list.html #}
{% extends "administrador/base_admin.html" %}
{% load static %}

{% block titulo %}Novedades{% endblock %}
{% block encabezado %}Novedades{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/site.css' %}">

<section id="newsx" class="newsx-section py-3">
  <div class="container-fluid">

    <!-- Toolbar superior -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center gap-2">
        <a class="btn btn-gradient rounded-3" href="{% url 'index:panel_news_new' %}">
          <i class="bi bi-plus-lg me-1"></i> Nueva
        </a>
        <a class="btn btn-outline-secondary rounded-3" href="{% url 'index:novedades' %}" target="_blank">
          <i class="bi bi-box-arrow-up-right me-1"></i> Ver en público
        </a>
      </div>
      <span class="text-secondary small">{{ posts|length }} elemento(s)</span>
    </div>

    <!-- HERO (dinámico si existe; si no, fallback MK) -->
    {% if hero %}
      <article id="post-{{ hero.pk }}" class="newsx-feature newsx-item mb-4" data-cat="{{ hero.tag|lower }}">
        <figure class="newsx-feature-media">
          {% if hero.image %}
            <img loading="lazy" src="{{ hero.image.url }}" alt="{{ hero.title|escape }}">
          {% else %}
            <img loading="lazy" src="https://images.unsplash.com/photo-1570829460005-c840387bb1ca?q=80&w=1600&auto=format&fit=crop" alt="{{ hero.title|escape }}">
          {% endif %}
          <figcaption class="newsx-feature-tag">
            {% if hero.get_tag_display %}{{ hero.get_tag_display }}{% else %}{{ hero.tag }}{% endif %}
          </figcaption>
        </figure>

        <div class="newsx-feature-body">
          <h2 class="fw-bold">{{ hero.title }}</h2>
          {% if hero.excerpt %}
            <p class="text-secondary mb-3">{{ hero.excerpt }}</p>
          {% endif %}

          {% if hero.body %}
            <details>
              <summary class="newsx-more">Leer la historia completa</summary>
              <div class="newsx-full">{{ hero.body|safe }}</div>
            </details>
          {% endif %}

          <!-- Acciones ADMIN en el HERO -->
          <div class="d-flex flex-wrap gap-2 mt-3">
            <button class="btn btn-gradient btn-sm rounded-3 px-3 newsx-share">
              <i class="bi bi-share me-1"></i> Compartir
            </button>

            <a class="btn btn-sm btn-outline-secondary"
               href="{% url 'index:panel_news_edit' hero.pk %}">
              <i class="bi bi-pencil-square me-1"></i> Editar
            </a>

            <form method="post"
                  action="{% url 'index:panel_news_pub' hero.pk %}?next={{ request.get_full_path|urlencode }}#post-{{ hero.pk }}"
                  class="d-inline">
              {% csrf_token %}
              <button class="btn btn-sm {% if hero.published %}btn-outline-warning{% else %}btn-outline-success{% endif %}">
                {% if hero.published %}<i class="bi bi-eye-slash me-1"></i> Ocultar{% else %}<i class="bi bi-eye me-1"></i> Publicar{% endif %}
              </button>
            </form>

            <form method="post"
                  action="{% url 'index:panel_news_feat' hero.pk %}?next={{ request.get_full_path|urlencode }}#post-{{ hero.pk }}"
                  class="d-inline">
              {% csrf_token %}
              <button class="btn btn-sm {% if hero.featured %}btn-warning{% else %}btn-outline-warning{% endif %}">
                <i class="bi bi-star{% if not hero.featured %}-half{% endif %} me-1"></i> Destacar
              </button>
            </form>

            <a class="btn btn-sm btn-outline-danger" href="{% url 'index:panel_news_del' hero.pk %}">
              <i class="bi bi-trash me-1"></i> Eliminar
            </a>
          </div>
        </div>
      </article>
    {% else %}
      <!-- Fallback estático (solo visual) -->
      <article id="post-mk" class="newsx-feature newsx-item mb-4" data-cat="mk">
        <figure class="newsx-feature-media">
          <img loading="lazy"
               src="https://images.unsplash.com/photo-1570829460005-c840387bb1ca?q=80&w=1600&auto=format&fit=crop"
               alt="Estudio de Pilates con reformers">
          <figcaption class="newsx-feature-tag">Historia MK</figcaption>
        </figure>
        <div class="newsx-feature-body">
          <h2 class="fw-bold">Michael King Pilates: la escuela que inspira nuestro enfoque</h2>
          <p class="text-secondary mb-3">
            Michael King ha sido una de las voces más influyentes del Pilates contemporáneo. Su método combina
            precisión, musicalidad y fluidez, con énfasis en la calidad del movimiento por sobre la cantidad.
          </p>

          <div class="alert alert-info py-2 px-3 rounded-3">
            Para que este bloque sea <strong>editable</strong>, marca alguna novedad como
            <strong>Destacada</strong> y <strong>Publicada</strong>.
            <a class="btn btn-sm btn-primary ms-2" href="{% url 'index:panel_news_new' %}">
              + Nueva destacada
            </a>
          </div>

          <details class="mt-2">
            <summary class="newsx-more">Leer la historia completa</summary>
            <div class="newsx-full">
              <p>Desde los años 80, King llevó el Pilates a nuevos públicos y formó instructores en decenas de países…</p>
              <div class="newsx-strip my-3" aria-label="Galería del estudio">
                <img loading="lazy" src="https://images.unsplash.com/photo-1575052814086-f385e2e2ad1b?q=80&w=1200&auto=format&fit=crop" alt="Clase de reformer">
                <img loading="lazy" src="https://images.unsplash.com/photo-1599050751795-5f0b0c0f2a9d?q=80&w=1200&auto=format&fit=crop" alt="Trabajo de centro">
                <img loading="lazy" src="https://images.unsplash.com/photo-1546483875-ad9014c88eba?q=80&w=1200&auto=format&fit=crop" alt="Postura y control">
                <img loading="lazy" src="https://images.unsplash.com/photo-1588286840104-8957b019727f?q=80&w=1200&auto=format&fit=crop" alt="Respiración y fluidez">
              </div>
            </div>
          </details>
        </div>
      </article>
    {% endif %}

    <!-- GRID de tarjetas (el hero ya viene excluido desde la vista) -->
    <div id="newsxGrid" class="newsx-grid">
      {% for p in posts %}
      <article id="post-{{ p.pk }}" class="newsx-card newsx-item" data-cat="{{ p.tag|lower }}">
        <figure class="newsx-media">
          {% if p.image %}
            <img loading="lazy" src="{{ p.image.url }}" alt="{{ p.title|escape }}">
          {% else %}
            <img loading="lazy" src="https://images.unsplash.com/photo-1552196563-55cd4e45efb3?q=80&w=1200&auto=format&fit=crop" alt="{{ p.title|escape }}">
          {% endif %}
          <span class="newsx-tag">
            {% if p.get_tag_display %}{{ p.get_tag_display }}{% else %}{{ p.tag }}{% endif %}
          </span>
          {% if not p.published %}
            <span class="newsx-tag" style="right:auto;left:10px;background:#fff3cd;color:#7a5c00;border-color:#ffe69c;">Borrador</span>
          {% endif %}
          {% if p.featured %}
            <span class="newsx-tag" style="top:44px;"><i class="bi bi-star-fill"></i> Destacado</span>
          {% endif %}
        </figure>

        <div class="newsx-card-body">
          <div class="newsx-meta">
            <span>{% if p.get_tag_display %}{{ p.get_tag_display }}{% else %}{{ p.tag }}{% endif %}</span>
            {% if p.published_at %}<small> · {{ p.published_at|date:"d M" }}</small>{% endif %}
          </div>

          <h3>{{ p.title }}</h3>
          {% if p.excerpt %}<p class="text-secondary m-0">{{ p.excerpt }}</p>{% endif %}

          {% if p.body %}
          <details>
            <summary class="newsx-more">Leer más</summary>
            <div class="newsx-full">{{ p.body|safe }}</div>
          </details>
          {% endif %}

          <!-- Acciones ADMIN -->
          <div class="d-flex flex-wrap gap-2 mt-2">
            <button class="btn btn-sm btn-outline-secondary newsx-share">
              <i class="bi bi-share me-1"></i> Compartir
            </button>

            <a class="btn btn-sm btn-outline-secondary" href="{% url 'index:panel_news_edit' p.pk %}">
              <i class="bi bi-pencil-square me-1"></i> Editar
            </a>

            <form method="post" action="{% url 'index:panel_news_pub' p.pk %}?next={{ request.get_full_path|urlencode }}#post-{{ p.pk }}" class="d-inline">
              {% csrf_token %}
              <button class="btn btn-sm {% if p.published %}btn-outline-warning{% else %}btn-outline-success{% endif %}">
                {% if p.published %}<i class="bi bi-eye-slash me-1"></i> Ocultar{% else %}<i class="bi bi-eye me-1"></i> Publicar{% endif %}
              </button>
            </form>

            <form method="post" action="{% url 'index:panel_news_feat' p.pk %}?next={{ request.get_full_path|urlencode }}#post-{{ p.pk }}" class="d-inline">
              {% csrf_token %}
              <button class="btn btn-sm {% if p.featured %}btn-warning{% else %}btn-outline-warning{% endif %}">
                <i class="bi bi-star{% if not p.featured %}-half{% endif %} me-1"></i> Destacar
              </button>
            </form>

            <a class="btn btn-sm btn-outline-danger" href="{% url 'index:panel_news_del' p.pk %}">
              <i class="bi bi-trash me-1"></i> Eliminar
            </a>
          </div>
        </div>
      </article>
      {% empty %}
        <div class="alert alert-light border">No hay novedades aún.</div>
      {% endfor %}
    </div>

    <!-- CTA newsletter -->
    <div class="newsx-cta mt-5 text-center">
      <div class="newsx-cta-inner d-inline-flex align-items-center gap-2">
        <i class="bi bi-envelope-open"></i>
        <input type="email" class="form-control border-0" placeholder="Tu email para recibir novedades" style="min-width:260px;">
        <button class="btn btn-gradient rounded-3 px-3">Suscribirme</button>
      </div>
      <div class="text-secondary small mt-2">Cero spam. Solo noticias útiles y promociones.</div>
    </div>

  </div>
</section>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const $$ = s => [...document.querySelectorAll(s)];

  const chips = $$('.newsx-chip');
  const items = $$('.newsx-item');
  const q = $('#newsxSearch');
  const qClear = $('#newsxClear');

  let cat = 'all';
  const norm = s => (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

  function apply(){
    const text = norm(q?.value?.trim() || '');
    items.forEach(el => {
      const inCat = (cat==='all') || (el.dataset.cat||'').includes(cat);
      const inText = !text || norm(el.textContent).includes(text);
      el.classList.toggle('d-none', !(inCat && inText));
    });
  }

  chips.forEach(btn => btn.addEventListener('click', () => {
    chips.forEach(c => c.classList.remove('is-active'));
    btn.classList.add('is-active');
    cat = btn.dataset.filter || 'all';
    apply();
  }));

  q && q.addEventListener('input', apply);
  qClear && qClear.addEventListener('click', ()=>{ q.value=''; apply(); q.focus(); });

  $$('.newsx-share').forEach(btn => {
    btn.addEventListener('click', async () => {
      const card = btn.closest('.newsx-item');
      const title = card?.querySelector('h2,h3')?.innerText?.trim() || 'PilatesReserva';
      const url = new URL(location.href);
      url.hash = card?.id || '';
      const data = { title: 'PilatesReserva', text: title, url: url.toString() };
      try {
        if (navigator.share) { await navigator.share(data); }
        else { await navigator.clipboard.writeText(data.url); btn.classList.add('is-copied'); setTimeout(()=>btn.classList.remove('is-copied'), 1000); }
      } catch {}
    });
  });

  function openHash(){
    if(location.hash){
      const el = document.querySelector(location.hash);
      if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); el.classList.add('newsx-focus'); setTimeout(()=>el.classList.remove('newsx-focus'),1200); }
    }
  }
  window.addEventListener('hashchange', openHash);
  openHash();

  apply();
})();
</script>
{% endblock %}
