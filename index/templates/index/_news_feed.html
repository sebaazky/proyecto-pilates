{# index/templates/index/_news_feed.html #}
<section id="newsx" class="newsx-section py-5">
  <div class="container">

    {# HERO (cabecera) #}
    <header class="newsx-hero text-center mb-4">
      <span class="chip small d-inline-flex align-items-center gap-1 mb-2"
            style="border:1px solid var(--lp-border);background:var(--lp-surface-2)">
        <i class="bi bi-megaphone"></i> Blog & Noticias
      </span>
      <h1 class="fw-bold m-0"><span class="newsx-grad">Novedades</span></h1>
      <p class="text-secondary m-0">Consejos, anuncios, promociones y la historia que nos inspira.</p>
    </header>

    {# CONTROLES (buscador + chips) #}
    <div class="newsx-controls">
      <div class="newsx-search">
        <i class="bi bi-search"></i>
        <input id="newsxSearch" type="search" class="form-control"
               placeholder="Buscar: reformer, respiración, eventos…"
               aria-label="Buscar en novedades" />
        <button id="newsxClear" class="btn btn-link" type="button" aria-label="Borrar búsqueda">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="newsx-chips" role="tablist" aria-label="Filtrar por categoría">
        <button class="newsx-chip is-active" data-filter="all" role="tab">Todo</button>
        <button class="newsx-chip" data-filter="consejos" role="tab">Consejos</button>
        <button class="newsx-chip" data-filter="eventos" role="tab">Eventos</button>
        <button class="newsx-chip" data-filter="promos" role="tab">Promos</button>
        <button class="newsx-chip" data-filter="mk" role="tab">Historia MK</button>
      </div>
    </div>

    {# =========================
       HERO DINÁMICO (EDITABLE)
       ========================= #}
    {% if hero %}
      <article id="post-{{ hero.pk }}" class="newsx-feature newsx-item mb-4" data-cat="{{ hero.tag|lower }}">
        <figure class="newsx-feature-media">
          {% if hero.image %}
            <img loading="lazy" src="{{ hero.image.url|default:hero.image }}" alt="{{ hero.title|escape }}" />
          {% else %}
            <img loading="lazy" src="https://images.unsplash.com/photo-1570829460005-c840387bb1ca?q=80&w=1600&auto=format&fit=crop" alt="{{ hero.title|escape }}" />
          {% endif %}
          <figcaption class="newsx-feature-tag">
            {% if hero.get_tag_display %}{{ hero.get_tag_display }}{% else %}{{ hero.tag }}{% endif %}
          </figcaption>
        </figure>

        <div class="newsx-feature-body">
          <h2 class="fw-bold">{{ hero.title }}</h2>
          {% if hero.excerpt %}
            <p class="text-secondary mb-3">{{ hero.excerpt }}</p>
          {% endif %}

          {% if hero.body %}
          <details>
            <summary class="newsx-more">Leer más</summary>
            <div class="newsx-full">{{ hero.body|safe }}</div>
          </details>
          {% endif %}

          {# === BOTONERA ADMIN ABAJO DEL HERO (solo en panel) === #}
          {% if is_panel %}
          <div class="d-flex flex-wrap gap-2 mt-3">
            <button class="btn btn-outline-secondary btn-sm rounded-3 newsx-share">
              <i class="bi bi-share me-1"></i> Compartir
            </button>

            <a class="btn btn-sm btn-outline-secondary"
               href="{% url 'index:panel_news_edit' hero.pk %}">
              <i class="bi bi-pencil-square me-1"></i> Editar
            </a>

            <form method="post"
                  action="{% url 'index:panel_news_pub' hero.pk %}?next={{ request.get_full_path|urlencode }}#post-{{ hero.pk }}"
                  class="d-inline">
              {% csrf_token %}
              <button class="btn btn-sm {% if hero.published %}btn-outline-warning{% else %}btn-outline-success{% endif %}">
                {% if hero.published %}<i class="bi bi-eye-slash me-1"></i> Ocultar{% else %}<i class="bi bi-eye me-1"></i> Publicar{% endif %}
              </button>
            </form>

            <form method="post"
                  action="{% url 'index:panel_news_feat' hero.pk %}?next={{ request.get_full_path|urlencode }}#post-{{ hero.pk }}"
                  class="d-inline">
              {% csrf_token %}
              <button class="btn btn-sm {% if hero.featured %}btn-warning{% else %}btn-outline-warning{% endif %}">
                <i class="bi bi-star{% if not hero.featured %}-half{% endif %} me-1"></i>
                {% if hero.featured %}Quitar destacado{% else %}Destacar{% endif %}
              </button>
            </form>

            <a class="btn btn-sm btn-outline-danger"
               href="{% url 'index:panel_news_del' hero.pk %}">
              <i class="bi bi-trash me-1"></i> Eliminar
            </a>
          </div>
          {% endif %}
        </div>
      </article>
    {% else %}
      {# =========================
         HERO ESTÁTICO (MK)
         + aviso en panel
         ========================= #}
      <article id="post-mk" class="newsx-feature newsx-item mb-4" data-cat="mk">
        <figure class="newsx-feature-media">
          <img loading="lazy"
               src="https://images.unsplash.com/photo-1570829460005-c840387bb1ca?q=80&w=1600&auto=format&fit=crop"
               alt="Estudio de Pilates con reformers" />
          <figcaption class="newsx-feature-tag">Historia MK</figcaption>
        </figure>
        <div class="newsx-feature-body">
          <h2 class="fw-bold">Michael King Pilates: la escuela que inspira nuestro enfoque</h2>
          <p class="text-secondary mb-3">
            Michael King ha sido una de las voces más influyentes del Pilates contemporáneo. Su método combina
            precisión, musicalidad y fluidez, con énfasis en la calidad del movimiento por sobre la cantidad.
          </p>
          <details>
            <summary class="newsx-more">Leer la historia completa</summary>
            <div class="newsx-full">
              <div class="newsx-timeline">
                <div class="newsx-step"><div class="newsx-dot"></div><div><h5>1980s · Orígenes y exploración</h5><p class="m-0">Adopta Pilates como base técnica.</p></div></div>
                <div class="newsx-step"><div class="newsx-dot"></div><div><h5>1990s · Fundación de MK Pilates</h5><p class="m-0">Nace el sistema educativo con mirada contemporánea.</p></div></div>
                <div class="newsx-step"><div class="newsx-dot"></div><div><h5>2000s · Expansión internacional</h5><p class="m-0">Workshops y certificaciones en varios países.</p></div></div>
                <div class="newsx-step"><div class="newsx-dot"></div><div><h5>2010s–Hoy · Evolución continua</h5><p class="m-0">Actualizaciones constantes y foco en la experiencia.</p></div></div>
              </div>
            </div>
          </details>

          {% if is_panel %}
          <div class="alert alert-info mt-3 mb-0 small">
            <strong>Tip:</strong> Para que este bloque superior sea editable, marca alguna novedad como
            <em>Destacada</em> (botón <span class="text-warning">⭐</span> “Destacar”) o crea una nueva y márcala como destacada.
            <a class="btn btn-sm btn-gradient ms-2" href="{% url 'index:panel_news_new' %}">
              <i class="bi bi-plus-lg"></i> Nueva destacada
            </a>
          </div>
          {% endif %}
        </div>
      </article>
    {% endif %}

    {# GRID (desde BD o diccionarios) #}
    <div id="newsxGrid" class="newsx-grid">
      {% for p in posts %}
      <article id="post-{% if p.pk %}{{ p.pk }}{% elif p.id %}{{ p.id }}{% else %}{{ forloop.counter }}{% endif %}"
               class="newsx-card newsx-item"
               data-cat="{{ p.tag|lower }}">
        <figure class="newsx-media">
          {% if p.image %}
            <img loading="lazy" src="{{ p.image.url|default:p.image }}" alt="{{ p.title|escape }}">
          {% else %}
            <img loading="lazy" src="https://images.unsplash.com/photo-1552196563-55cd4e45efb3?q=80&w=1200&auto=format&fit=crop" alt="{{ p.title|escape }}">
          {% endif %}

          <span class="newsx-tag">
            {% if p.get_tag_display %}{{ p.get_tag_display }}{% else %}{{ p.tag }}{% endif %}
          </span>

          {% if p.published == False %}
            <span class="newsx-draft">Borrador</span>
          {% endif %}
        </figure>

        {% if is_panel %}
        <div class="newsx-adminbar">
          <a class="btn btn-sm btn-outline-secondary" href="{% url 'index:panel_news_edit' p.pk %}" title="Editar">
            <i class="bi bi-pencil-square"></i>
          </a>

          <form method="post"
                action="{% url 'index:panel_news_pub' p.pk %}?next={{ request.get_full_path|urlencode }}#post-{{ p.pk }}"
                class="d-inline">
            {% csrf_token %}
            <button class="btn btn-sm {% if p.published %}btn-outline-warning{% else %}btn-outline-success{% endif %}"
                    title="{% if p.published %}Ocultar{% else %}Publicar{% endif %}">
              {% if p.published %}<i class="bi bi-eye-slash"></i>{% else %}<i class="bi bi-eye"></i>{% endif %}
            </button>
          </form>

          <form method="post"
                action="{% url 'index:panel_news_feat' p.pk %}?next={{ request.get_full_path|urlencode }}#post-{{ p.pk }}"
                class="d-inline">
            {% csrf_token %}
            <button class="btn btn-sm {% if p.featured %}btn-warning{% else %}btn-outline-warning{% endif %}" title="Destacar">
              <i class="bi bi-star{% if not p.featured %}-half{% endif %}"></i>
            </button>
          </form>

          <a class="btn btn-sm btn-outline-danger" href="{% url 'index:panel_news_del' p.pk %}" title="Eliminar">
            <i class="bi bi-trash"></i>
          </a>
        </div>
        {% endif %}

        <div class="newsx-card-body">
          <div class="newsx-meta">
            <span>{% if p.get_tag_display %}{{ p.get_tag_display }}{% else %}{{ p.tag }}{% endif %}</span>
            {% if p.published_at %}
              <small> · {{ p.published_at|date:"d M" }}</small>
            {% elif p.updated_at %}
              <small> · {{ p.updated_at|date:"d M" }}</small>
            {% elif p.date %}
              <small> · {{ p.date|date:"d M" }}</small>
            {% endif %}
          </div>

          <h3>{{ p.title }}</h3>
          {% if p.excerpt %}
            <p class="text-secondary m-0">{{ p.excerpt }}</p>
          {% endif %}

          {% if p.body %}
          <details>
            <summary class="newsx-more">Leer más</summary>
            <div class="newsx-full">{{ p.body|safe }}</div>
          </details>
          {% endif %}

          <div class="newsx-actions">
            <button class="btn btn-outline-secondary btn-sm rounded-3 newsx-share">
              <i class="bi bi-share me-1"></i> Compartir
            </button>
          </div>
        </div>
      </article>
      {% empty %}
        <div class="text-center text-muted py-5 w-100">No hay novedades aún.</div>
      {% endfor %}
    </div>

    {# CTA NEWSLETTER (opcional) #}
    <div class="newsx-cta mt-5 text-center">
      <div class="newsx-cta-inner d-inline-flex align-items-center gap-2">
        <i class="bi bi-envelope-open"></i>
        <input type="email" class="form-control border-0" placeholder="Tu email para recibir novedades" style="min-width:260px;">
        <button class="btn btn-gradient rounded-3 px-3">Suscribirme</button>
      </div>
      <div class="text-secondary small mt-2">Cero spam. Solo noticias útiles y promociones.</div>
    </div>
  </div>
</section>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const $$ = s => [...document.querySelectorAll(s)];

  const chips = $$('.newsx-chip');
  const items = $$('.newsx-item');
  const q = $('#newsxSearch');
  const qClear = $('#newsxClear');

  let cat = 'all';
  const norm = s => (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

  function apply(){
    const text = norm(q?.value?.trim() || '');
    items.forEach(el => {
      const inCat = (cat==='all') || (el.dataset.cat||'').includes(cat);
      const inText = !text || norm(el.textContent).includes(text);
      el.classList.toggle('d-none', !(inCat && inText));
    });
  }

  chips.forEach(btn => btn.addEventListener('click', () => {
    chips.forEach(c => c.classList.remove('is-active'));
    btn.classList.add('is-active');
    cat = btn.dataset.filter || 'all';
    apply();
  }));

  q && q.addEventListener('input', apply);
  qClear && qClear.addEventListener('click', ()=>{ q.value=''; apply(); q.focus(); });

  // Compartir
  $$('.newsx-share').forEach(btn => {
    btn.addEventListener('click', async () => {
      const card = btn.closest('.newsx-item');
      const title = card?.querySelector('h2,h3')?.innerText?.trim() || 'PilatesReserva';
      const url = new URL(location.href);
      url.hash = card?.id || '';
      const data = { title: 'PilatesReserva', text: title, url: url.toString() };
      try {
        if (navigator.share) { await navigator.share(data); }
        else { await navigator.clipboard.writeText(data.url); btn.classList.add('is-copied'); setTimeout(()=>btn.classList.remove('is-copied'), 1000); }
      } catch {}
    });
  });

  function openHash(){
    if(location.hash){
      const el = document.querySelector(location.hash);
      if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); el.classList.add('newsx-focus'); setTimeout(()=>el.classList.remove('newsx-focus'),1200); }
    }
  }
  window.addEventListener('hashchange', openHash);
  openHash();

  apply();
})();
</script>
